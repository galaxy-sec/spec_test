#!/bin/bash

# Use bash-specific features only if running in bash
if [ -n "${BASH_VERSION:-}" ]; then
    set -euo pipefail
else
    set -eu
fi

# æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
OS=""
if [ "$(uname)" = "Linux" ]; then
    OS="ubuntu"
    TARGET_DIR="/usr/bin"
elif [ "$(uname)" = "Darwin" ]; then
    OS="macos"
    TARGET_DIR="/usr/local/bin"
else
    echo "âŒ ä¸æ”¯æŒçš„OSç±»å‹: $(uname)"
    exit 1
fi
echo "âœ… æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS"
echo "ğŸ“ ç›®æ ‡å®‰è£…ç›®å½•: $TARGET_DIR"

# å®‰è£…opensslçš„å‡½æ•°
install_openssl() {
    echo "ğŸ” æ£€æµ‹OpenSSLå®‰è£…..."

    # 1. æ£€æŸ¥ openssl å‘½ä»¤æ˜¯å¦å­˜åœ¨
    if ! command -v openssl > /dev/null 2>&1; then
        echo "âš ï¸ OpenSSLæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
        if [ "$OS" = "ubuntu" ]; then
            sudo apt update
            sudo apt install -y openssl libssl-dev
        elif [ "$OS" = "macos" ]; then
            if ! command -v brew > /dev/null 2>&1; then
                echo "âŒ Homebrewæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Homebrew"
                exit 1
            fi
            brew install openssl
        fi
    fi

    # 2. æ£€æŸ¥ openssl ç‰ˆæœ¬
    OPENSSL_VERSION=$(openssl version 2>/dev/null | awk '{print $2}' | cut -d. -f1)
    if [ "$OS" = "ubuntu" ] && [ "$OPENSSL_VERSION" != "3" ]; then
        echo "âŒ æ£€æµ‹åˆ° OpenSSL ç‰ˆæœ¬ä¸æ˜¯ 3.xï¼Œè¯·ç¡®ä¿ä½ çš„ç³»ç»Ÿä¸º Ubuntu 22.04 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚"
        echo "    å¦‚æœæ˜¯ Ubuntu 20.04 æˆ–æ›´ä½ç‰ˆæœ¬ï¼Œè¯·å‡çº§ç³»ç»Ÿæˆ–æ‰‹åŠ¨å®‰è£… OpenSSL 3ã€‚"
        exit 1
    fi

    # 3. æ£€æŸ¥ libssl.so.3 æ˜¯å¦å­˜åœ¨
    if [ "$OS" = "ubuntu" ]; then
        if ! ls /usr/lib/x86_64-linux-gnu/libssl.so.3 >/dev/null 2>&1; then
            echo "âŒ æœªæ£€æµ‹åˆ° libssl.so.3 (OpenSSL 3)ï¼Œè¯·ç¡®ä¿ä½ çš„ç³»ç»Ÿä¸º Ubuntu 22.04 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚"
            echo "    å¦‚æœæ˜¯ Ubuntu 20.04 æˆ–æ›´ä½ç‰ˆæœ¬ï¼Œè¯·å‡çº§ç³»ç»Ÿæˆ–æ‰‹åŠ¨å®‰è£… OpenSSL 3ã€‚"
            exit 1
        fi
    fi

    echo "âœ… OpenSSL 3 (libssl.so.3) å·²å°±ç»ª"
}

# è·å–æœ€æ–°ç‰ˆæœ¬å·ï¼ˆç®€åŒ–ç‰ˆæœ¬å¤„ç†ï¼‰
get_latest_version() {
    file=$1
    version_url=""
    
    if [ "$OS" = "ubuntu" ]; then
        version_url="https://dy-sec-generic.pkg.coding.net/galaxy-open/ubuntu22/${file}_latest_version.txt"
    elif [ "$OS" = "macos" ]; then
        version_url="https://dy-sec-generic.pkg.coding.net/galaxy-open/macos/${file}_latest_version.txt"
    fi
    
    echo "ğŸ” è·å– ${file} æœ€æ–°ç‰ˆæœ¬..." >&2
    # ç›´æ¥è·å–ç‰ˆæœ¬å·å¹¶å»é™¤å°¾éƒ¨æ¢è¡Œç¬¦
    version=$(curl -fsL "$version_url" | tr -d '\n')
    
    if [ -z "$version" ]; then
        echo "âŒ æ— æ³•è·å– ${file} çš„æœ€æ–°ç‰ˆæœ¬" >&2
        exit 1
    fi
    
    echo "âœ… ${file} æœ€æ–°ç‰ˆæœ¬: $version" >&2
    echo "$version"
}

# ä¸‹è½½å¹¶å®‰è£…æ–‡ä»¶çš„å‡½æ•°
download_and_install() {
    files="ds-sys ds-mod gflow gprj"
    base_url=""
    
    if [ "$OS" = "ubuntu" ]; then
        base_url="https://dy-sec-generic.pkg.coding.net/galaxy-open/ubuntu22/"
    elif [ "$OS" = "macos" ]; then
        base_url="https://dy-sec-generic.pkg.coding.net/galaxy-open/macos/"
    fi

    for file in $files; do
        # è·å–æœ€æ–°ç‰ˆæœ¬å·
        version=$(get_latest_version "$file")
        
        # æ„å»ºå¸¦ç‰ˆæœ¬å·çš„ä¸‹è½½URL
        download_url="${base_url}${file}?version=${version}"
        
        echo "â¬‡ï¸ ä¸‹è½½ $file (ç‰ˆæœ¬: $version)..."
        curl -fL "$download_url" -o "$file"
        
        if [ -f "$file" ]; then
            chmod +x "$file"
            echo "ğŸ”§ ç§»åŠ¨ $file åˆ° $TARGET_DIR"
            
            # ç§»åŠ¨æ–‡ä»¶åˆ°ç³»ç»Ÿè·¯å¾„
            sudo mv -f "$file" "$TARGET_DIR/$file"
            
            # éªŒè¯å®‰è£…
            if command -v "$file" > /dev/null 2>&1; then
                echo "âœ… $file å®‰è£…æˆåŠŸ"
            else
                echo "âŒ $file å®‰è£…å¤±è´¥"
                exit 1
            fi
        else
            echo "âŒ $file ä¸‹è½½å¤±è´¥"
            exit 1
        fi
    done
}

# ä¸»æ‰§è¡Œæµç¨‹
main() {
    install_openssl
    download_and_install
    echo ""
    echo "ğŸ‰ æ‰€æœ‰æ“ä½œå·²å®Œæˆï¼æ–‡ä»¶å·²å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„: $TARGET_DIR"
}

main
